<!DOCTYPE html>
{% load staticfiles %}
<head>
	<title>Toorrents</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="shortcut icon" href="{% static 'downloader/favicon.ico' %}" />

	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

	<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.4/angular.min.js"></script>

	<link rel="stylesheet" type="text/css" href="{% static 'downloader/style.css' %}" />
</head>


<div class="body" ng-app="myApp" ng-controller="queryCtrl">

	<div class="container site_header">
	  <div class="page-header">
		<header>Toorrents</header>
	  </div>
	  <description> search multiple queries simultaneously over multiple search engines </description>
	</div>
	<br>

    <div class="container main_app">

        <ul class="nav nav-tabs" style="margin:10px;">
            {% for engine in Answer %}
                {% if forloop.first %}
                    <li id="tab_{{engine}}" class="active" onclick="changeTab('{{engine}}')"><a>{{engine}}</a></li>
                {% else %}
                    <li id="tab_{{engine}}" onclick="changeTab('{{engine}}')" ><a>{{engine}}</a></li>
                {% endif %}
            {% endfor %}
        </ul>

        {% for engine, names in Answer.items %}

            {% if forloop.first %}
                <div id="tab_div_{{engine}}">
                    <script>
                        var currShownDiv = "tab_{{engine}}";
                    </script>
            {% else %}
                <div id="tab_div_{{engine}}" style="display:none">
            {% endif %}

                {% for name, results in names.items %}

                    <div class="result_header" data-toggle="collapse" data-target="#{{engine}}_{{name}}_collapse">
                        <h2 class="result_h2">Results for "{{name}}": </h2>
                    </div>
                    <div id="{{engine}}_{{name}}_collapse" class="collapse result_container">
                        <table class="table table-striped table-hover" id="TBA">
                        <thead>
                            <tr>

                                <!-- <th></th> -->

                                <th>Name</th>
                                <th>General Info</th>
                                <th>Seeds</th>
                                <th>leeches</th>
                                <th>Download</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in results %}
                            <tr class="tr" >

                                <!-- <td><input type="checkbox" ng-click="updateSelection($event, key, $index)"></td> -->

                                <td class="td td-responsive">{{r.0}} </td>
                                <td class="td td-responsive">{{r.1}} </td>
                                <td class="td td-responsive">{{r.2}} </td>
                                <td class="td td-responsive">{{r.3}} </td>
                                <td class="td td-responsive">
                                    <a href="{{r.4}}" class="btn _pull-right myButton" title="Magnet Link">Download</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                {%endfor%}
            </div>
        {% endfor %}
    </div>

    </div>
</div>

<script>
    var currShownDiv = "{% for k,v in Answer.items %}{%if forloop.first %}{{k}}{% else %}{%endif%}{% endfor %}";
    function changeTab(engine) {

        $('#tab_'+currShownDiv).removeClass('active');
        $('#tab_'+engine).addClass('active');

        $('#tab_div_'+currShownDiv).css('display', 'none');
        $('#tab_div_'+engine).css('display', 'block');
        currShownDiv = engine;
    }

var app = angular.module('myApp', [], function ($compileProvider) {

  $compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|magnet):/);

});
app.controller('queryCtrl', function($scope, $location, $anchorScroll) {
    $scope.engines = { 'KickassTorrents':{"active":1, "name": 'Kickass Torrents'}, 'ThePirateBay':{"active":1, "name": 'The Pirate Bay'}};
    $scope.queries = new Array();
    $scope.results = {};

    $scope.stub = function()
    {
        alert('wow');
    }

    $scope.ok = function()
	{
		if(!$scope.query)
			alert("Please enter a non empty query into the list");
		else
		{
			$scope.queries.push(angular.copy($scope.query));
			$scope.query = "";
		}
    };

	$scope.remove = function(index)
	{
		$scope.queries.splice(index,1);
	};

	$scope.submit = function()
	{
		$scope.submited_queries = $scope.queries;
		$scope.queries = new Array();
	};

	$scope.go = function(Qs) {
        if (!Qs)
        {
            alert('Please enter some queries into the list')
        }
        $('#myModal').modal({backdrop: 'static', keyboard: false});
		$('#myModal').modal('show');
        var _url = "{% url 'search' %}";
        var handler500 = function() { alert("500: Internal Server Error"); };
		var data = {"csrfmiddlewaretoken": "{{ csrf_token }}", state:"inactive", "Qs": Qs, "Engine": ""};

        //*
        for (var key in $scope.engines) {

            if($scope.engines[key]["active"] == 1)
            {
                data["Engine"] = key;
                searchQueries(_url, data);
            }
        }
        //*/
        //searchQueries(_url, data);
    };

    function searchQueries(_url, data)
    {
        $.post(_url, data).done(function(response)
		{
			$('#myModal').modal('hide');
			//alert(response);
            $scope.$apply(function() {
					$scope.results = {};
				});
			if(response)
			{
				//alert(JSON.stringify(response));
				$scope.$apply(function() {
                    //console.log("key: " + Object.keys(response))
					//$scope.results[Object.keys(response)[0]] = [];
					$scope.results[Object.keys(response)[0]] = response[Object.keys(response)[0]];
				});
				$('.scrollToCollapsee').unbind('shown.bs.collapse' , goToElement );
				$('.scrollToCollapsee').unbind('hidden.bs.collapse', goToElement );
				$('.scrollToCollapsee').bind('shown.bs.collapse' , goToElement );
				$('.scrollToCollapsee').bind('hidden.bs.collapse', goToElement );
				//$('#main_app').hide();
				goToElementById('results')

//                $scope.showMyDiv(data.Engine);
//                console.log('#ref_' + data.Engine);
                $('#ref_' + data.Engine).trigger('click');
			}
			else
			{
				alert("empty");
			}
		}).fail(function()
		{
			$('#myModal').modal('hide');
			alert("Failed To Search Queries");
		});
    }

	function goToElement(event)
	{
		var id = event.currentTarget.id;
		goToElementById(id)
	};

	function goToElementById(id)
	{
		$location.hash(id);
		$anchorScroll();
	};

	$scope.updateQuery = function(index)
	{
		var input = '#query_input_' + index;
		var label = '#query_text_'  + index;

		$(input).val($(label).text());
		$(input).show();

		$(label).hide();
	};

	$scope.submited_query = function(index)
	{
		var input = '#query_input_' + index;
		var label = '#query_text_'  + index;

		var text = $(input).val();
		$(label).text(text);
		$(input).hide();
		$(label).show();

		$scope.queries[index] = text;
	}

    $scope.selectEngine = function(key)
    {
        $scope.engines[key]['active'] = 1 - $scope.engines[key]['active'];
    }

    $scope.currShownDiv = "";
    $scope.showMyDiv = function(id) {
        alert('wow');
        if ($scope.currShownDiv)
        {
            var old_id = '#' + $scope.currShownDiv;
//            $(old_id).hide();
            $(old_id).css('diplay: none');
        }

        $scope.currShownDiv = id;

        var new_id = '#' + id;
//        $(new_id).show();
        $(new_id).css('diplay: block');
    }


});

app.filter('active_only', function() {

    // In the return function, we must pass in a single parameter which will be the data we will work on.
    // We have the ability to support multiple other parameters that can be passed into the filter optionally
    return function(input) {

        var output = {};

        // Do filter work here

        for (var e in input)
        {
            if(input[e]['active'] == 1)
                output[e] = input[e]
        }
//        console.log(JSON.stringify(output))
//        output = input;


        return output;

    }

});

</script>