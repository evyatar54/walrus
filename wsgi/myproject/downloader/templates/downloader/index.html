{% load staticfiles %}
<head>
	<title>Toorrents</title>
	<link rel="shortcut icon" href="{% static 'downloader/favicon.ico' %}" />

	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

	<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.4/angular.min.js"></script>

	<link rel="stylesheet" type="text/css3" href="{% static 'downloader/style.css' %}" />
</head>

{% verbatim %}
<div class="_body" ng-app="myApp" ng-controller="queryCtrl">
	
	<div class="container site_header">
	  <div class="page-header">
		<header>Toorrents</header>      
	  </div>
	  <description> search multiple queries simultaneously over multiple search engines </description>
	</div>
	
	<div class="container select-engines">
		<div class="select-engines-button">
			<button class="btn myButton" data-toggle="collapse" data-target="#select-engines">
				Select Search Engines
			</button>
		</div>
		<div id="select-engines" class="collapse select-engines-body">
            <div class="engines-block">
                <label class="checkbox-inline search-engine-holder"
                                    ng-repeat="(e, val) in engines track by $index">
                    <input type="checkbox" value="" ng-click="selectEngine(e);" checked>
                        {{e}}
                    </input>
                </label>
            </div>
		</div>
	</div>
	<br>
	<div id="main_app" class="container main_app">

		<div class="query_area">
			
			<form novalidate>
				<div class="well" style="white-space: nowrap">
						<input class="input insert_query" placeholder="Enter Query" type="text" ng-model="query"/> 
						<button class="btn myButton" ng-click="ok()"> Add </button>
				</div>
			</form>
			
			<div class="table_area">
				<table class="table table-striped table-hover" id="quries_table">
					<tr class="tr" ng-repeat="x in queries track by $index" ng-init="queryIndex = $index">
						<td class="td"> 
							<table>
								<td class ="query_cell">
									<div class="query_div">
										<p id="query_text_{{$index}}">{{x}}<p>
										<input id="query_input_{{$index}}" class="input edit_query" 
										ng-blur="submited_query($index)" ng-enter="submited_query($index)" type="text" />
									</div>
								</td>
								<td class="query_edit">
									<button class="btn pull-right myButton" ng-click="updateQuery(queryIndex)"> Edit </button>
								</td>
								<td class="query_remove">
									<button class="btn pull-right myButton" ng-click="remove(queryIndex)"> Remove </button>
								</td>
							</table>
						</td>
					</tr>
				</table>
			</div>
		</div>
		<br>

		<div class="container buttom_toolbar">
			<br>
			<button class="btn pull-right myButton" ng-click="go(queries)">
				Search <span class="glyphicon glyphicon-search"></span> 
			</button>
		</div>
	</div>
	<br>

    <div class="select-engines-body" style="background-color: white">
        <ul class="nav nav-tabs">
            <li ng-repeat="(e,val) in engines"> <a href="#" ng-click="" p="//show('#m1');">{{e}}</a> </li>
        </ul>

    </_div>


	<div class="container" id="results">
	
		<div class="modal fade" id="myModal" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
					  <h4 class="modal-title">Loading</h4>
					</div>
					<div class="modal-body">
						Please wait while searching for results ...
					</div>
				</div>
			</div> 
		</div>
		<div class="container result_area" >
		
		<!-- <button class="btn pull-right" ng-click="downloadSelected()">Get All Selected</button> -->
		
			<div class="container" ng-repeat="(key, r) in results" ng-init="parentIndex = $index">
				<div class="result_header" data-toggle="collapse" data-target="#result_div_{{parentIndex}}"><h2 class="result_h2">Results for "{{key}}": </h2></div>			
				<div id="result_div_{{parentIndex}}" class="collapse scrollToCollapsee result_container">
				<table class="table table-striped table-hover" id="result_table_{{parentIndex}}">
					<thead>
						<tr>
						
							<!-- <th></th> --> 
							
							<th>Name</th>
							<th>General Info</th>
							<th>Seeds</th>
							<th>leeches</th>
							<th>Download</th>
						</tr>
					</thead>
					<tbody>
						<tr class="tr" ng-repeat="line in r track by $index" ng-class="getSelectedClass(line)">
						
							<!-- <td><input type="checkbox" ng-click="updateSelection($event, key, $index)"></td> -->
							
							<td class="td">{{line[0]}} </td>
							<td class="td">{{line[1]}} </td>
							<td class="td">{{line[2]}} </td>
							<td class="td">{{line[3]}} </td>
							<td class="td">
								<a href="{{line[4]}}" class="btn _pull-right myButton" title="Magnet Link">Download</a>
							</td>
						</tr>
					</tbody>
				</table>
				</div>
			</div>
		</div>
	</div>
	<br>
</div>
{% endverbatim  %}

<script>
	
var app = angular.module('myApp', [], function ($compileProvider) {

  $compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|magnet):/);
  
});
app.controller('queryCtrl', function($scope, $location, $anchorScroll) {
    $scope.engines = {'The Pirate Bay':1, 'KickassTorrents':1};
    $scope.queries = new Array();
    $scope.results = new Array();

    $scope.ok = function()
	{
		if(!$scope.query)
			alert("Query must be non empty.\ngot: " + $scope.query);
		else
		{
			$scope.queries.push(angular.copy($scope.query));
			$scope.query = "";
		}
    };
	
	$scope.remove = function(index)
	{
		$scope.queries.splice(index,1);
	};
	
	$scope.submit = function()
	{
		$scope.submited_queries = $scope.queries;
		$scope.queries = new Array();
	};
	
	$scope.go = function(Qs)
	{	
		$('#myModal').modal({backdrop: 'static', keyboard: false});
		$('#myModal').modal('show');
		var _url = "{% url 'search' %}";
        var handler500 = function() { alert("500: Internal Server Error"); };
		var data = {"csrfmiddlewaretoken": "{{ csrf_token }}", state:"inactive", "Qs": Qs, "Engine": ""};

        /*
        for (var key in $scope.engines)
        {
            //console.log(key);
            data["Engine"] = key;
            console.log(data)
        }
        */
        searchQueries(_url, data);
    };

    function searchQueries(_url, data)
    {
        $.post(_url, data).done(function(response)
		{
			$('#myModal').modal('hide');
			//alert(response);
			if(response)
			{
				//alert(JSON.stringify(response));
				$scope.$apply(function() {
					$scope.results = [];
					$scope.results = response;
				});
				$('.scrollToCollapsee').unbind('shown.bs.collapse' , goToElement );
				$('.scrollToCollapsee').unbind('hidden.bs.collapse', goToElement );
				$('.scrollToCollapsee').bind('shown.bs.collapse' , goToElement );
				$('.scrollToCollapsee').bind('hidden.bs.collapse', goToElement );
				//$('#main_app').hide();
				goToElementById('results')
			}
			else
			{
				alert("empty");
			}
		}).fail(function()
		{
			$('#myModal').modal('hide');
			alert("Failed To Search Queries");
		});
    }

	function goToElement(event)
	{
		var id = event.currentTarget.id;
		goToElementById(id)
	};
	
	function goToElementById(id)
	{
		$location.hash(id);
		$anchorScroll();
	};
	
	$scope.updateQuery = function(index)
	{
		var input = '#query_input_' + index;
		var label = '#query_text_'  + index;
		
		$(input).val($(label).text());
		$(input).show();
		
		$(label).hide();
	};
	
	$scope.submited_query = function(index)
	{
		var input = '#query_input_' + index;
		var label = '#query_text_'  + index;
		
		var text = $(input).val();
		$(label).text(text);
		$(input).hide();
		$(label).show();
		
		$scope.queries[index] = text;
	}

    $scope.selectEngine = function(key)
    {
        $scope.engines[key] = 1 - $scope.engines[key];
    }




	/*
	 ********* functions regarding to multiple choosing and downloading: ********
	
	$scope.selected = {};
	$scope.updateSelection = function($event, table, index)
	{
		var checkbox = $event.target;
		var action = (checkbox.checked ? 'add' : 'remove');		
		if(typeof($scope.selected[table]) === 'undefined')
		{
			$scope.selected[table] = [];
		}
		if(action == 'add')
		{
			$scope.selected[table].push(index);
		}
		else
		{
			$scope.selected[table].splice($scope.selected[table].indexOf(index),1);
		}
		
	}
	$scope.downloadSelected = function()
	{
		//alert("This service is temporarily unavailable as a result of  
		var array = [];
		for (var arr in $scope.selected)
		{
			for (var index in $scope.selected[arr])
			{
				array.push($scope.results[arr][index][4]);
			}	
		}
		var win;
		for (var i=0; i<array.length; i++)
		{
			console.log(array[i]);
			win = window.open(array[i],'download_window'+i);
			win.close();
		}
	}
	function download_magnets(index, magnets)
	{
		if( i==0 )
			window.open(array[i],'_self');
		else
		{
			if(confirm("want another one ?"))
			{
				window.open(array[i],'_parent');
			}
			else
			{
				break;
			}
		}
	}
	//################### Until Here #######################*/
})
.directive('ngEnter', function() {
        return function(scope, element, attrs) {
            element.bind("keydown keypress", function(event) {
                if(event.which === 13) {
                    scope.$apply(function(){
                        scope.$eval(attrs.ngEnter, {'event': event});
                    });

                    event.preventDefault();
                }
            });
        };
    });

/*	
$(document).ready(function() {
    $('div.body').scrolll(function() {
		console.log($('#sticky-div').offset());
        if ($('#sticky-anchor').offset().top <= 0)
        {
			$('#sticky-div').removeClass('my_nav');
			$('#sticky-div').removeClass('navbar-static-top');
            $('#sticky-div').addClass('navbar-fixed-top');
			//$('#sticky-div').addClass('_my_nav');
        }
        else
        {
			$('#sticky-div').removeClass('navbar-fixed-top');
            $('#sticky-div').addClass('navbar-static-top');
			$('#sticky-div').addClass('my_nav');
        }
    });
	
});
//*/
</script>

