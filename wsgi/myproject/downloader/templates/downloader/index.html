{% load staticfiles %}
<head>
	<title>Toorrents</title>
	<link rel="stylesheet" type="text/css" href="{% static 'downloader/style.css' %}" />
	<link rel="shortcut icon" href="{% static 'downloader/favicon.ico' %}" />

	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

	<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.4/angular.min.js"></script>

</head>

{% verbatim %}
<div class="body" ng-app="myApp" ng-controller="queryCtrl">

	<div class="jumbotron well row site_header">
		<div class="col-md-6">
			<h1> Toorrents </h1>
		</div>
		<div class="col-md-6">
			<br><br><br><p> search multiple queries simultaneously over multiple search engines </p>
		</div>
	</div>
	<br>
	<div class="container main_app">

		<div class="raw query_area">
			
			<form novalidate>
				<div class="col-md-12 raw well">
					<div class="col-md-11"> 
						<input class="input" placeholder="Enter Query" type="text" ng-model="query"/> 
					</div>
					<div class="col-md-1"> 	
						<button class="btn btn-info my_button" ng-click="ok()"> OK </button>
					</div>
				</div>
			</form>
			
			<div class="table_area">
				<table class="table table-striped table-hover" id="quries_table">
					<tr class="tr" ng-repeat="x in queries track by $index">
						<td class="td"> <content contenteditable="true">{{x}}</content> <button class="btn btn-info pull-right my_button" ng-click="remove($index)"> Remove </button> </td>
					</tr>
				</table>
			</div>
		</div>
		
	</div>

	<br>

	<div class="container buttom_toolbar">
		<br>
		<button class="btn btn-info pull-right" ng-click="go(queries)">submit</button>
	</div>
	
	<br>
	<div class="modal fade" id="myModal" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header" style="height:40px;">
				  <h4 class="modal-title">Loading</h4>
				</div>
				<div class="modal-body">
					wait while searching for results ...
				</div>
			</div>
		</div> 
	</div>
	<div class="container result_area" >
	
	<!-- <button class="btn btn-info pull-right" ng-click="downloadSelected()">Get All Selected</button> -->
	
		<div class="container" ng-repeat="(key, r) in results" ng-init="parentIndex = $index">
			<div data-toggle="collapse" data-target="#result_div_{{parentIndex}}" style="width:100%;border-style:groove;"><h2>results for: {{key}}</h2></div>			
			<div id="result_div_{{parentIndex}}" class="collapse" style="height:400px;overflow-y:scroll;border-style:groove;max-height:400px;" >
			<table class="table table-striped table-hover" id="result_table_{{parentIndex}}">
				<thead>
					<tr>
					
						<!-- <th></th> --> 
						
						<th>Name</th>
						<th>General Info</th>
						<th>Seeds</th>
						<th>leeches</th>
						<th>Download</th>
					</tr>
				</thead>
				<tbody>
					<tr class="tr" ng-repeat="line in r track by $index" ng-class="getSelectedClass(line)">
					
						<!-- <td><input type="checkbox" ng-click="updateSelection($event, key, $index)"></td> -->
						
						<td class="td">{{line[0]}} </td>
						<td class="td">{{line[1]}} </td>
						<td class="td">{{line[2]}} </td>
						<td class="td">{{line[3]}} </td>
						<td class="td">
							<a href="{{line[4]}}" class="btn btn-info pull-right" title="Magnet Link">Download</a>
						</td>
					</tr>
				</tbody>
			</table>
			</div>
		</div>
	</div>
	<br>
</div>
{% endverbatim  %}

<script>
	
var app = angular.module('myApp', [], function ($compileProvider) {

  $compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|magnet):/);

});

app.controller('queryCtrl', function($scope) {
	$scope.queries = new Array();
	$scope.results = new Array();
	$scope.wow = ""
    $scope.ok = function() 
	{
		if(!$scope.query)
			alert("Query must be non empty.\ngot: " + $scope.query);
		else
		{
			$scope.queries.push(angular.copy($scope.query));
			$scope.query = "";
		}
    };
	
	$scope.remove = function(index)
	{
		$scope.queries.splice(index,1);
	};
	
	$scope.submit = function()
	{
		$scope.submited_queries = $scope.queries;
		$scope.queries = new Array();
	};
	
	$scope.go = function(Qs)
	{	
		$('#myModal').modal({backdrop: 'static', keyboard: false});
		$('#myModal').modal('show');
		var _url = "{% url 'search' %}";
		var handler500 = function() { alert("500: Internal Server Error"); };
		data = {"csrfmiddlewaretoken": "{{ csrf_token }}", state:"inactive", "Qs": Qs};
		$.post(_url, data).done(function(response)
		{
			$('#myModal').modal('hide');
			//alert(response);
			if(response)
			{
				//alert(JSON.stringify(response));
				$scope.$apply(function() { 
					$scope.results = response;
				});
				
				$('.collapse').on('shown.bs.collapse', function (e) 
				{
					var id = '#'+e.currentTarget.id;
					var new_pos = $(id).offset().top+400;
					//alert( id + ', ' + new_pos);
					$('body,html').animate({scrollTop: new_pos},800);
				});
				$('.collapse').on('hidden.bs.collapse', function (e) 
				{
					var id = '#'+e.currentTarget.id;
					var new_pos = $(id).offset().top +400;
					$('html,body').animate({scrollTop: $(this).offset().top}, 800);
				});
			}
			else
			{
				alert("empty");
			}
		}).fail(function()
		{
			$('#myModal').modal('hide');
			alert("Failed To Search Queries");
		});
	}
	
	
	/*
	 * functions regarding to multiple choosing and downloading: *
	
	$scope.selected = {};
	$scope.updateSelection = function($event, table, index)
	{
		var checkbox = $event.target;
		var action = (checkbox.checked ? 'add' : 'remove');		
		if(typeof($scope.selected[table]) === 'undefined')
		{
			$scope.selected[table] = [];
		}
		if(action == 'add')
		{
			$scope.selected[table].push(index);
		}
		else
		{
			$scope.selected[table].splice($scope.selected[table].indexOf(index),1);
		}
		
	}
	$scope.downloadSelected = function()
	{
		//alert("This service is temporarly unavailable as a result of  
		var array = [];
		for (var arr in $scope.selected)
		{
			for (var index in $scope.selected[arr])
			{
				array.push($scope.results[arr][index][4]);
			}	
		}
		var win;
		for (var i=0; i<array.length; i++)
		{
			console.log(array[i]);
			win = window.open(array[i],'download_window'+i);
			win.close();
		}
	}
	function download_magnets(index, magnets)
	{
		if( i==0 )
			window.open(array[i],'_self');
		else
		{
			if(confirm("want another one ?"))
			{
				window.open(array[i],'_parent');
			}
			else
			{
				break;
			}
		}
	}
	//################### Until Here #######################*/
});


</script>

